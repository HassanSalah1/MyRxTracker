---
globs: app/Models/*.php,database/migrations/*.php,database/seeders/*.php
description: Database models, migrations, and relationships development guidelines
---

# Database & Models Development

## Model Architecture

### Core Models Structure
The application uses several key models with specific relationships:

#### User Model
The central model in [app/Models/User.php](mdc:app/Models/User.php) with comprehensive functionality:

```php
class User extends Authenticatable
{
    use HasFactory, Notifiable, HasApiTokens, SoftDeletes;
    use \App\Traits\HasRoles;

    protected $fillable = [
        'name', 'email', 'password', 'role', 'status',
        'image', 'mobile', 'identity_number', 'pack_id',
        'fcm_token', 'notification_permission',
        'otp_code', 'otp_expires_at', 'otp_attempts', 'otp_locked_until',
    ];

    protected $casts = [
        'role' => Roles::class,
        'status' => UserStatus::class,
    ];

    // Relationships
    public function pack() { return $this->belongsTo(Pack::class); }
    public function packs() { return $this->hasManyThrough(Pack::class, 'user_packs'); }
    public function starterPacks() { return $this->hasOne(StarterPack::class); }
    public function onTrackApplications() { return $this->hasMany(OnTrackPack::class); }
    public function attendingEvents() { return $this->belongsToMany(Event::class)->withTimestamps(); }
    public function photos() { return $this->hasMany(UserPhoto::class, 'user_id'); }
}
```

#### Pack Management Models
Multiple pack-related models for different application types:

**StarterPack Model** ([app/Models/StarterPack.php](mdc:app/Models/StarterPack.php)):
```php
class StarterPack extends Model
{
    protected $fillable = [
        'user_id', 'doctor_id', 'pack_id', 'date_of_application',
        'verification_status', 'serial_no', 'certificate_path', 'doctor_name'
    ];

    public function user() { return $this->belongsTo(User::class); }
    public function doctor() { return $this->belongsTo(Doctor::class); }
    public function pack() { return $this->belongsTo(Pack::class); }
}
```

**OnTrackPack Model** ([app/Models/OnTrackPack.php](mdc:app/Models/OnTrackPack.php)):
```php
class OnTrackPack extends Model
{
    protected $fillable = [
        'user_id', 'doctor_id', 'doctor_name', 'pack_id',
        'application_date', 'next_consultation_date', 'receipt_path',
        'verification_status', 'used_for_redemption'
    ];

    protected $casts = [
        'application_date' => 'datetime',
        'next_consultation_date' => 'datetime',
        'used_for_redemption' => 'boolean',
    ];
}
```

#### Role & Permission Models
**Role Model** ([app/Models/Role.php](mdc:app/Models/Role.php)):
```php
class Role extends Model
{
    protected $fillable = [
        'name', 'guard_name', 'display_name', 'description', 'is_default'
    ];

    protected $casts = [
        'is_default' => 'boolean',
        'created_at' => 'datetime',
        'updated_at' => 'datetime',
    ];

    public function permissions(): BelongsToMany
    {
        return $this->belongsToMany(Permission::class, 'role_has_permissions');
    }

    public function users(): MorphToMany
    {
        return $this->morphedByMany(User::class, 'model', 'model_has_roles');
    }

    public function hasPermission(string $permission): bool
    {
        return $this->permissions->contains('name', $permission);
    }
}
```

## Migration Patterns

### Standard Migration Structure
Follow the pattern in [database/migrations/](mdc:database/migrations/):

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('table_name', function (Blueprint $table) {
            $table->id();
            $table->string('name');
            $table->string('email')->unique();
            $table->timestamp('email_verified_at')->nullable();
            $table->string('password');
            $table->rememberToken();
            $table->timestamps();
            $table->softDeletes();
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('table_name');
    }
};
```

### User Table Migration
The users table includes OTP-related fields:

```php
Schema::create('users', function (Blueprint $table) {
    $table->id();
    $table->string('name');
    $table->string('email')->unique();
    $table->timestamp('email_verified_at')->nullable();
    $table->string('password');
    $table->string('role')->default('user');
    $table->string('status')->default('active');
    $table->string('image')->nullable();
    $table->string('mobile')->unique();
    $table->string('identity_number')->nullable();
    $table->unsignedBigInteger('pack_id')->nullable();
    $table->string('fcm_token')->nullable();
    $table->boolean('notification_permission')->default(true);
    
    // OTP fields
    $table->string('otp_code')->nullable();
    $table->timestamp('otp_expires_at')->nullable();
    $table->integer('otp_attempts')->default(0);
    $table->timestamp('otp_locked_until')->nullable();
    
    $table->rememberToken();
    $table->timestamps();
    $table->softDeletes();
    
    $table->foreign('pack_id')->references('id')->on('packs');
});
```

### Multilingual Fields
For multilingual content, use separate fields:

```php
Schema::create('events', function (Blueprint $table) {
    $table->id();
    $table->string('title_en');
    $table->string('title_zh');
    $table->text('description_en')->nullable();
    $table->text('description_zh')->nullable();
    $table->string('image')->nullable();
    $table->timestamps();
    $table->softDeletes();
});
```

### Pivot Tables
For many-to-many relationships:

```php
Schema::create('event_user', function (Blueprint $table) {
    $table->id();
    $table->foreignId('event_id')->constrained()->onDelete('cascade');
    $table->foreignId('user_id')->constrained()->onDelete('cascade');
    $table->timestamps();
});
```

## Seeder Patterns

### Basic Seeder Structure
Follow the pattern in [database/seeders/](mdc:database/seeders/):

```php
<?php

namespace Database\Seeders;

use Illuminate\Database\Seeder;
use App\Models\Model;
use Illuminate\Support\Facades\Hash;

class ModelSeeder extends Seeder
{
    public function run(): void
    {
        Model::create([
            'name' => 'Example Name',
            'email' => 'example@example.com',
            'password' => Hash::make('password'),
            'role' => 'admin',
            'status' => 'active',
        ]);
    }
}
```

### Role & Permission Seeder
The [database/seeders/RolePermissionSeeder.php](mdc:database/seeders/RolePermissionSeeder.php) demonstrates complex seeding:

```php
public function run(): void
{
    // Create permissions
    $permissions = [
        ['name' => 'manage-users', 'display_name' => 'Manage Users', 'module' => 'users'],
        ['name' => 'view-users', 'display_name' => 'View Users', 'module' => 'users'],
        ['name' => 'edit-users', 'display_name' => 'Edit Users', 'module' => 'users'],
        ['name' => 'delete-users', 'display_name' => 'Delete Users', 'module' => 'users'],
    ];

    foreach ($permissions as $permission) {
        Permission::create($permission);
    }

    // Create roles
    $adminRole = Role::create([
        'name' => 'admin',
        'display_name' => 'Administrator',
        'description' => 'Full system access',
        'is_default' => false,
    ]);

    // Assign permissions to roles
    $adminRole->syncPermissions(Permission::all());
}
```

## Model Relationships

### Relationship Types

#### One-to-One
```php
// User has one StarterPack
public function starterPacks()
{
    return $this->hasOne(StarterPack::class);
}
```

#### One-to-Many
```php
// User has many OnTrackPack applications
public function onTrackApplications()
{
    return $this->hasMany(OnTrackPack::class);
}
```

#### Many-to-Many
```php
// User belongs to many Events
public function attendingEvents()
{
    return $this->belongsToMany(Event::class)->withTimestamps();
}
```

#### Many-to-Many Through
```php
// User has many Packs through user_packs pivot table
public function packs()
{
    return $this->hasManyThrough(Pack::class, 'user_packs');
}
```

### Relationship Conventions
- Always define the inverse relationship
- Use descriptive method names
- Include timestamps for many-to-many relationships
- Use proper foreign key constraints

## Enum Usage

### Model Enum Casting
Use enums for status fields as shown in [app/Models/User.php](mdc:app/Models/User.php):

```php
protected $casts = [
    'role' => Roles::class,
    'status' => UserStatus::class,
];
```

### Enum Definition
Define enums in [app/Enums/](mdc:app/Enums/):

```php
<?php

namespace App\Enums;

enum UserStatus: string
{
    case ACTIVE = 'active';
    case INACTIVE = 'inactive';
    case SUSPENDED = 'suspended';
    case PENDING = 'pending';
}
```

## Database Conventions

### Naming Conventions
- **Tables**: snake_case, plural (e.g., `users`, `starter_packs`)
- **Columns**: snake_case (e.g., `created_at`, `user_id`)
- **Foreign Keys**: `{model}_id` (e.g., `user_id`, `pack_id`)
- **Pivot Tables**: `{model1}_{model2}` (e.g., `event_user`)

### Indexing
```php
// Add indexes for frequently queried columns
$table->index('email');
$table->index('mobile');
$table->index(['status', 'created_at']);
$table->index('otp_expires_at');
```

### Constraints
```php
// Foreign key constraints
$table->foreign('user_id')->references('id')->on('users')->onDelete('cascade');
$table->foreign('pack_id')->references('id')->on('packs')->onDelete('set null');

// Unique constraints
$table->unique('email');
$table->unique('mobile');
```

## Model Best Practices

### Mass Assignment Protection
Always define `$fillable` arrays:

```php
protected $fillable = [
    'name', 'email', 'password', 'role', 'status',
    'image', 'mobile', 'identity_number', 'pack_id',
];
```

### Attribute Casting
Use proper casting for data types:

```php
protected $casts = [
    'email_verified_at' => 'datetime',
    'password' => 'hashed',
    'role' => Roles::class,
    'status' => UserStatus::class,
    'is_active' => 'boolean',
    'metadata' => 'array',
];
```

### Soft Deletes
Use soft deletes for important models:

```php
use Illuminate\Database\Eloquent\SoftDeletes;

class Model extends Model
{
    use SoftDeletes;
    
    protected $dates = ['deleted_at'];
}
```

### Scopes
Define query scopes for common queries:

```php
public function scopeActive($query)
{
    return $query->where('status', 'active');
}

public function scopeByRole($query, $role)
{
    return $query->where('role', $role);
}
```

### Accessors and Mutators
Use accessors and mutators for data transformation:

```php
// Accessor
public function getFullNameAttribute()
{
    return "{$this->first_name} {$this->last_name}";
}

// Mutator
public function setPasswordAttribute($value)
{
    $this->attributes['password'] = Hash::make($value);
}
```

## Performance Optimization

### Eager Loading
Use eager loading to prevent N+1 queries:

```php
// In controllers
$users = User::with(['pack', 'starterPacks', 'onTrackApplications'])->get();

// In Filament resources
public static function getEloquentQuery(): Builder
{
    return parent::getEloquentQuery()->withCount('attendees')->with('attendees');
}
```

### Database Indexes
Add indexes for frequently queried columns:

```php
$table->index('email');
$table->index('mobile');
$table->index('status');
$table->index('created_at');
```

### Query Optimization
Use efficient queries:

```php
// Use select to limit columns
User::select('id', 'name', 'email')->get();

// Use where clauses effectively
User::where('status', 'active')->where('role', 'user')->get();

// Use pagination for large datasets
User::paginate(15);
```